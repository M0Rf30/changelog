sudo: required

services:
  - docker

language: go
go:
  - 1.8
  - 1.9

env:
  global:
    - APP=changelog
    - GH=mh-cbon/changelog
    - EMAIL=mh-cbon@users.noreply.github.com
    - JEKYLL=pietromenna/jekyll-cayman-theme
    - MYEMAIL=mh-cbon@users.noreply.github.com # to clean
    - MYAPP=changelog # to clean
    - secure: glOfB5HbTQrm+pjsYiICU8Sei7tWarKy33XSTGlUiPx2cAWJ+pso7chiV2osqn7nGNbtb94h9utpYPtJAv9JIY/O+v7Opmy6R0kmv31SBIf0llzfvmCg8mkKDR/RBxvVH91mnJFjgWjYidpbYtROnalI+zdzn9wg6c1otC3PM6avYwZY/5C0Tv7ZWva2vlbQBGbipkOrBLCS6W9dyfX3Sw+c9PkaAqpZKLdKdoalS6eCT+IWagQh8PTJtqvZOACcBBexp/25yC/3ZwoM1ktXXCu7pR2ad1Gu0omjvH6gV/90fyNcidKzWUEeSHwUHuX5u0t+Her+vPAfcANzaflYzqyxaKQanuDav0/6S42eDVs7KkLO23e30Hb402o+3pGGccFhARrOAYF3KgCy7FWTIaeQzf4rEl5/5MAytEMMuZucY8iqMCi8pCWfzBLR2b5prULD4RrjanomtQQXclmkm8bf/4nwBcxKSDqvMjNph4MFS7IT/G+CVoFom+RMiibi+tdvKbt1TDHiLUvp+la3XKSWYgsusslgHxAu1nhakrWy75WXn0V6ubzBmEiLGMG6WPn4x0/MB7WMl3zm9dfYh4EDCmdNo4dnbwmAEdTQgeELigkQcR+lvSkNhaHo/4eI+wqvrXHdPjmGe8keXWmd/oEqFgGo1PHtO5gx95OFopU=

before_install:
  - sudo apt-get -qq update
  - mkdir -p ${GOPATH}/bin
  - cd ~
  - curl https://glide.sh/get | sh

install:
  - cd $GOPATH/src/github.com/mh-cbon/$APP
  - glide install
  - go install

script:
  - go test changelog/*
  - go test tpls/*
  - go test
  - wget -O - https://raw.githubusercontent.com/mh-cbon/gh-pages/master/all.sh | sh -x

before_deploy:
  - mkdir -p build/{386,amd64}
  - GOOS=linux GOARCH=386 go build --ldflags "-X main.VERSION=${TRAVIS_TAG}" -o build/386/changelog main.go
  - GOOS=linux GOARCH=amd64 go build --ldflags "-X main.VERSION=${TRAVIS_TAG}" -o build/amd64/changelog main.go
  - curl -L https://raw.githubusercontent.com/mh-cbon/go-bin-deb/master/create-pkg.sh | GH=$GH sh -xe
  - curl -L https://raw.githubusercontent.com/mh-cbon/go-bin-rpm/master/create-pkg.sh | GH=$GH sh -xe

after_deploy:
  - wget -O - https://raw.githubusercontent.com/mh-cbon/gh-pages/master/all.sh | sh -x
  - curl -L https://raw.githubusercontent.com/mh-cbon/go-bin-deb/master/setup-repository.sh | GH=$GH EMAIL=$EMAIL sh -xe
  - curl -L https://raw.githubusercontent.com/mh-cbon/go-bin-rpm/master/setup-repository.sh | GH=$GH EMAIL=$EMAIL sh -xe

deploy:
  provider: releases
  api_key:
    secure: J9oRiOHW2SYlBwk/Ekpgk1EzURG3jTtjlOZ6E/LFAkwQCxpjEQDA0xo5iZWyJb5H2E3g9LToIzUbAFxI5vItCpWXSt0BJCyH/yMlHli6IfdQHOSrqcjWyde9F/Y1Se+8heLdzQtxvsEIUqVjMLnQhQqxN6EfLx/UpVumWALQipFVgMD9dfDJSycRlRF4tL1sCSEMWjdCgyoUBPeIIPthtjkaHH2WynwpitWfwvshDZ2+lHvC+JfoSDPdY+EEe4h/tTcKd20zTZNcKTKBF9sDIMbb0kZIa16JYlp7QguJai4domPahKTPfsZDY6zkHNNMc1NSpO6bUvcYcIsgGHEYciiYUkBlEciFHLyGC6w0UbxXAd0MIK1nMQJ7XMeoz0km2YGWTPJlAn3n4gu9XHHqSPeiV+YUu09qf42L7gEQoYm+w0B14LKGCWoYCQHxuU0T68eOaexe/xnAtGDY0+g+nV4gUsHj6L0WyUNPeu+LnHdHzw2S3dWAltOKvtlBs40YSm1vXQInJwWWMAHyt8SVeMr5+GnyGtpLKg7/U5/tiSEDou8id0lHXxjFxOEzT+PY5mhgjM5UOmv4ekQSAuBZAlV1JYxq2kL/4feWGp1b4V3148wDskCFWSZf+jp0IbrA8qs9LwnhFJado6IGP3W2LlbuQigak5uJQw3SbahRd10=
  file_glob: true
  file:
    - $APP-386.deb
    - $APP-amd64.deb
    - $APP-386.rpm
    - $APP-amd64.rpm
  skip_cleanup: true
  on:
    tags: true
